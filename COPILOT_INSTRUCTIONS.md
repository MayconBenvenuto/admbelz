# ü§ñ GitHub Copilot Instructions - CRM Belz

## üìã Vis√£o Geral do Projeto

Este √© um **CRM (Customer Relationship Management)** desenvolvido para a **Belz**, focado em gest√£o de propostas de planos de sa√∫de. O sistema implementa controle de acesso baseado em roles, seguran√ßa robusta e interface moderna.

### üéØ Objetivo Principal
Gerenciar propostas de planos de sa√∫de com diferentes n√≠veis de acesso para analistas (criadores) e gestores (monitores).

---

## üèóÔ∏è Arquitetura do Projeto

### üìÅ Estrutura de Pastas
```
emergent-crm-adm/
‚îú‚îÄ‚îÄ app/                          # Next.js App Router
‚îÇ   ‚îú‚îÄ‚îÄ api/[[...path]]/          # API routes centralizadas
‚îÇ   ‚îú‚îÄ‚îÄ globals.css               # Estilos globais + Montserrat
‚îÇ   ‚îú‚îÄ‚îÄ layout.js                 # Layout raiz
‚îÇ   ‚îî‚îÄ‚îÄ page.js                   # P√°gina principal do CRM
‚îú‚îÄ‚îÄ components/ui/                # Componentes Shadcn/UI
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ security.js               # Fun√ß√µes de seguran√ßa
‚îÇ   ‚îú‚îÄ‚îÄ supabase.js              # Cliente Supabase
‚îÇ   ‚îî‚îÄ‚îÄ utils.js                  # Utilit√°rios gerais
‚îú‚îÄ‚îÄ hooks/                        # React hooks customizados
‚îî‚îÄ‚îÄ public/
    ‚îî‚îÄ‚îÄ logo-belz.jpg            # Logo da empresa
```

### üîß Stack Tecnol√≥gica
- **Frontend**: Next.js 14.2.3 + React 18
- **UI**: Shadcn/UI + TailwindCSS + Lucide Icons
- **Backend**: Next.js API Routes
- **Database**: Supabase (PostgreSQL)
- **Auth**: JWT + bcryptjs
- **Styling**: TailwindCSS + CSS Variables
- **Fonts**: Montserrat (Google Fonts)

---

## üé® Design System

### üé® Paleta de Cores (Belz)
```css
/* Cores principais da Belz */
--primary: #130E54;        /* Azul escuro Belz */
--secondary: #021d79;      /* Azul m√©dio */
--background: #f6f6f6;     /* Cinza claro */
--card: #ffffff;           /* Branco para cards */
--muted: #6b7280;          /* Cinza m√©dio para texto secund√°rio */
```

### üìù Tipografia
- **Font Primary**: Montserrat (Google Fonts)
- **Font Class**: `.font-montserrat`
- **Weights**: 400 (Regular), 500 (Medium), 600 (SemiBold), 700 (Bold)

### üñºÔ∏è Layout
- **Sidebar**: Fixa √† esquerda, 256px de largura
- **Header**: Din√¢mico baseado na se√ß√£o ativa
- **Content**: √Årea principal flex√≠vel com scroll independente

---

## üë• Sistema de Roles e Permiss√µes

### üîê Tipos de Usu√°rio

#### **Analista** (Criador de Propostas)
```javascript
// Permiss√µes do analista
const analistaPermissions = {
  propostas: {
    create: true,    // ‚úÖ Criar propostas
    read: true,      // ‚úÖ Visualizar propostas
    update: false,   // ‚ùå Editar propostas
    delete: false,   // ‚ùå Excluir propostas
    status: false    // ‚ùå Alterar status
  },
  dashboard: true,   // ‚úÖ Ver dashboard
  usuarios: false,   // ‚ùå Gerenciar usu√°rios
  relatorios: false  // ‚ùå Ver relat√≥rios
}
```

#### **Gestor** (Monitor e Aprovador)
```javascript
// Permiss√µes do gestor
const gestorPermissions = {
  propostas: {
    create: false,   // ‚ùå Criar propostas
    read: true,      // ‚úÖ Visualizar propostas
    update: true,    // ‚úÖ Editar propostas
    delete: true,    // ‚úÖ Excluir propostas
    status: true     // ‚úÖ Alterar status
  },
  dashboard: true,   // ‚úÖ Ver dashboard
  usuarios: true,    // ‚úÖ Gerenciar usu√°rios
  relatorios: true   // ‚úÖ Ver relat√≥rios
}
```

---

## üõ°Ô∏è Seguran√ßa e Autentica√ß√£o

### üîí Implementa√ß√µes de Seguran√ßa
```javascript
// lib/security.js - Fun√ß√µes principais
- hashPassword()           // Hash bcrypt com 12 rounds
- verifyPassword()         // Verifica√ß√£o de senha
- generateToken()          // JWT com 24h de expira√ß√£o
- verifyToken()            // Valida√ß√£o JWT
- checkRateLimit()         // Limite de tentativas
- sanitizeInput()          // Sanitiza√ß√£o XSS
- validateEmail()          // Valida√ß√£o de email
- validateCNPJ()           // Valida√ß√£o de CNPJ
- addSecurityHeaders()     // Headers de seguran√ßa
```

### üõ°Ô∏è Headers de Seguran√ßa
```javascript
// Headers implementados
'X-Content-Type-Options': 'nosniff'
'X-Frame-Options': 'DENY'
'X-XSS-Protection': '1; mode=block'
'Referrer-Policy': 'strict-origin-when-cross-origin'
'Permissions-Policy': 'camera=(), microphone=(), geolocation=()'
'Strict-Transport-Security': 'max-age=31536000; includeSubDomains' // Produ√ß√£o
```

### üîê Rate Limiting
- **Login**: M√°ximo 100 tentativas por 15 minutos por IP
- **APIs**: Limita√ß√£o configur√°vel via ENV
- **Storage**: Map em mem√≥ria (usar Redis em produ√ß√£o)

---

## üóÑÔ∏è Estrutura do Banco de Dados

### üìä Tabelas Principais

#### **usuarios**
```sql
CREATE TABLE usuarios (
  id SERIAL PRIMARY KEY,
  nome VARCHAR(255) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  senha_hash VARCHAR(255) NOT NULL,
  tipo_usuario VARCHAR(50) NOT NULL CHECK (tipo_usuario IN ('analista', 'gestor')),
  criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **propostas**
```sql
CREATE TABLE propostas (
  id SERIAL PRIMARY KEY,
  cnpj VARCHAR(18) NOT NULL,
  consultor VARCHAR(255) NOT NULL,
  operadora VARCHAR(100) NOT NULL,
  quantidade_vidas INTEGER NOT NULL,
  valor DECIMAL(10,2) NOT NULL,
  previsao_implantacao DATE,
  status VARCHAR(50) DEFAULT 'em an√°lise',
  criado_por INTEGER REFERENCES usuarios(id),
  criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **sessoes**
```sql
CREATE TABLE sessoes (
  id SERIAL PRIMARY KEY,
  usuario_id INTEGER REFERENCES usuarios(id),
  session_id VARCHAR(255) NOT NULL,
  ip_address VARCHAR(45),
  user_agent TEXT,
  inicio_sessao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  ultima_atividade TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  ativa BOOLEAN DEFAULT true
);
```

#### **metas_usuario**
```sql
CREATE TABLE metas_usuario (
  id SERIAL PRIMARY KEY,
  usuario_id INTEGER REFERENCES usuarios(id),
  meta_propostas INTEGER NOT NULL,
  propostas_fechadas INTEGER DEFAULT 0,
  mes_ano VARCHAR(7) NOT NULL, -- YYYY-MM
  criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## üîå API Endpoints

### üõ£Ô∏è Rotas Principais (`/api/[[...path]]`)

#### **Autentica√ß√£o**
```javascript
POST /api/auth/login
Body: { email: string, password: string }
Response: { user: object, sessionId: string, token: string }
```

#### **Propostas**
```javascript
// Listar propostas
GET /api/proposals
Response: [{ id, cnpj, consultor, operadora, quantidade_vidas, valor, status, ... }]

// Criar proposta (apenas analistas)
POST /api/proposals
Body: { cnpj, consultor, operadora, quantidade_vidas, valor, previsao_implantacao }

// Atualizar status (apenas gestores)
PUT /api/proposals/:id/status
Body: { status: string }

// Deletar proposta (apenas gestores)
DELETE /api/proposals/:id
```

#### **Usu√°rios** (apenas gestores)
```javascript
// Listar usu√°rios
GET /api/users

// Criar usu√°rio
POST /api/users
Body: { nome, email, senha, tipo_usuario }
```

#### **Valida√ß√£o CNPJ**
```javascript
POST /api/validate-cnpj
Body: { cnpj: string }
Response: { valid: boolean, data?: object, error?: string }
```

#### **Sess√µes e Relat√≥rios**
```javascript
GET /api/sessions      // Listar sess√µes ativas
GET /api/goals         // Metas e progresso dos usu√°rios
```

---

## üìä Funcionalidades Principais

### üìù Gest√£o de Propostas

#### **Status Dispon√≠veis**
```javascript
const statusOptions = [
  'em an√°lise',
  'pendencias seguradora', 
  'boleto liberado',
  'implantando',
  'pendente cliente',
  'pleito seguradora',
  'negado',
  'implantado'
];
```

#### **Operadoras Suportadas**
```javascript
const operadoras = [
  'unimed recife',
  'unimed seguros', 
  'bradesco',
  'amil',
  'ampla',
  'fox',
  'hapvida',
  'medsenior',
  'sulamerica',
  'select'
];
```

### üîç Valida√ß√£o de CNPJ (Cascata)
```javascript
// Ordem de tentativa das APIs
1. ReceitaWS      (https://receitaws.com.br/v1/cnpj/{cnpj})
2. BrasilAPI      (https://brasilapi.com.br/api/cnpj/v1/{cnpj})
3. CNPJA          (https://api.cnpja.com/office/{cnpj})

// Retorno padronizado
{
  valid: boolean,
  data: {
    cnpj: string,
    razao_social: string,
    nome_fantasia: string,
    situacao_cadastral: string,
    cnae_fiscal_descricao: string,
    logradouro: string,
    numero: string,
    bairro: string,
    municipio: string,
    uf: string,
    cep: string,
    telefone: string,
    email: string,
    source: 'ReceitaWS' | 'BrasilAPI' | 'CNPJA'
  }
}
```

### üìà Dashboard e M√©tricas
- **Cards de resumo**: Total de propostas, por status, valores
- **Gr√°ficos**: Distribui√ß√£o por operadora e status
- **Progresso**: Metas individuais vs atingido
- **Auto-refresh**: Atualiza√ß√£o autom√°tica dos dados

### üë• Gest√£o de Usu√°rios (Gestor)
- **Cria√ß√£o**: Novos analistas e gestores
- **Listagem**: Todos os usu√°rios do sistema
- **Tipos**: Analista (criador) / Gestor (monitor)

### üìä Relat√≥rios e Monitoramento (Gestor)
- **Sess√µes ativas**: Usu√°rios online e √∫ltima atividade
- **Logs de acesso**: Hist√≥rico de logins e IPs
- **Metas**: Progresso individual e da equipe

---

## üíª Padr√µes de C√≥digo

### ‚öõÔ∏è React Patterns

#### **Hooks Customizados**
```javascript
// Exemplo: useAutoRefresh
const useAutoRefresh = (callback, interval = 30000) => {
  useEffect(() => {
    const timer = setInterval(callback, interval);
    return () => clearInterval(timer);
  }, [callback, interval]);
};
```

#### **State Management**
```javascript
// Estados principais do CRM
const [currentUser, setCurrentUser] = useState(null);
const [activeTab, setActiveTab] = useState('propostas');
const [proposals, setProposals] = useState([]);
const [users, setUsers] = useState([]);
const [sessions, setSessions] = useState([]);
const [userGoals, setUserGoals] = useState([]);
```

#### **Conditional Rendering**
```javascript
// Baseado em permiss√µes
{currentUser.tipo_usuario === 'gestor' && (
  <Button onClick={handleDeleteProposal}>Excluir</Button>
)}

{currentUser.tipo_usuario !== 'gestor' && (
  <Button onClick={handleCreateProposal}>Nova Proposta</Button>
)}
```

### üé® CSS Patterns

#### **Layout Classes**
```css
/* Sidebar fixo */
.sidebar {
  @apply w-64 bg-card border-r shadow-lg flex flex-col;
}

/* Content area flex√≠vel */
.content-area {
  @apply flex-1 flex flex-col;
}

/* Cards padr√£o */
.card-standard {
  @apply bg-card border rounded-lg shadow-sm;
}
```

#### **Responsive Design**
```css
/* Mobile first approach */
.responsive-grid {
  @apply grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4;
}
```

### üîí Security Patterns

#### **Input Sanitization**
```javascript
// Sempre sanitizar inputs
const sanitizedInput = sanitizeInput(userInput);
const isValidEmail = validateEmail(email);
const isValidCNPJ = validateCNPJFormat(cnpj);
```

#### **API Error Handling**
```javascript
try {
  const response = await fetch('/api/endpoint', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify(sanitizedData)
  });
  
  if (!response.ok) {
    const error = await response.json();
    toast.error(error.message || 'Erro na opera√ß√£o');
    return;
  }
  
  const result = await response.json();
  toast.success('Opera√ß√£o realizada com sucesso!');
} catch (error) {
  console.error('Erro:', sanitizeForLog(error));
  toast.error('Erro de conex√£o com o servidor');
}
```

---

## üåç Vari√°veis de Ambiente

### üìÑ .env (Configura√ß√£o Local)
```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# Security Configuration
JWT_SECRET=secure_32_character_secret_key_here
BCRYPT_ROUNDS=12
SESSION_TIMEOUT=86400000

# CORS Configuration
CORS_ORIGINS=http://localhost:3000,https://yourdomain.com

# Rate Limiting
RATE_LIMIT_WINDOW=900000
RATE_LIMIT_MAX_REQUESTS=100
```

### üìÑ .env.example (Template)
```bash
# ‚ö†Ô∏è CONFIGURE COM SUAS PR√ìPRIAS CHAVES

# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key_here

# Security Configuration
JWT_SECRET=uma_chave_super_secreta_com_no_minimo_32_caracteres
BCRYPT_ROUNDS=12
SESSION_TIMEOUT=86400000

# CORS Configuration  
CORS_ORIGINS=http://localhost:3000

# Rate Limiting
RATE_LIMIT_WINDOW=900000
RATE_LIMIT_MAX_REQUESTS=100
```

---

## üöÄ Scripts de Desenvolvimento

### üì¶ package.json Scripts
```json
{
  "scripts": {
    "dev": "next dev --hostname 0.0.0.0 --port 3000",
    "build": "next build",
    "start": "next start"
  }
}
```

### üõ†Ô∏è Comandos √öteis
```bash
# Desenvolvimento
npm run dev

# Build produ√ß√£o
npm run build

# Iniciar produ√ß√£o
npm run start

# Instalar depend√™ncias
npm install
```

---

## üß™ Testing Patterns

### üîç Valida√ß√£o Manual
```javascript
// Testar permiss√µes
// 1. Login como analista - verificar se pode criar propostas
// 2. Login como gestor - verificar se pode alterar status
// 3. Testar rate limiting - muitas tentativas de login
// 4. Testar valida√ß√£o CNPJ - CNPJ v√°lido e inv√°lido
// 5. Testar responsividade - mobile e desktop
```

### üêõ Debug Patterns
```javascript
// Logs seguros (sem dados sens√≠veis)
console.log('Opera√ß√£o:', sanitizeForLog(operation));
console.error('Erro:', sanitizeForLog(error));

// Toast notifications
toast.success('‚úÖ Opera√ß√£o realizada com sucesso!');
toast.error('‚ùå Erro na opera√ß√£o');
toast.info('‚ÑπÔ∏è Informa√ß√£o importante');
```

---

## üîÑ Deployment

### üåê GitHub Deployment
```bash
# Verificar arquivos sens√≠veis
git status
cat .gitignore

# Commit seguro
git add .
git commit -m "feat: nova funcionalidade"
git push origin main
```

### ‚ö†Ô∏è Checklist de Seguran√ßa
- [ ] Arquivo .env n√£o commitado
- [ ] Credenciais rotacionadas se expostas
- [ ] Headers de seguran√ßa configurados
- [ ] Rate limiting ativo
- [ ] Logs sanitizados
- [ ] CORS restritivo configurado

---

## üìö Recursos e Refer√™ncias

### üìñ Documenta√ß√£o
- **Next.js**: https://nextjs.org/docs
- **Shadcn/UI**: https://ui.shadcn.com
- **TailwindCSS**: https://tailwindcss.com/docs
- **Supabase**: https://supabase.com/docs

### üé® Design Resources
- **Lucide Icons**: https://lucide.dev
- **Montserrat Font**: https://fonts.google.com/specimen/Montserrat
- **Color Palette**: Belz brand colors (#130E54, #021d79, #f6f6f6)

### üîí Security Resources
- **JWT**: https://jwt.io
- **bcrypt**: https://github.com/kelektiv/node.bcrypt.js
- **OWASP**: https://owasp.org/www-project-top-ten/

---

## ü§ñ GitHub Copilot Guidelines

### ‚úÖ Quando Sugerir C√≥digo
1. **Seguir padr√µes estabelecidos** no projeto
2. **Implementar seguran√ßa** por padr√£o
3. **Usar componentes Shadcn/UI** existentes
4. **Respeitar permiss√µes** de usu√°rio
5. **Sanitizar inputs** sempre
6. **Usar toast notifications** para feedback
7. **Implementar loading states** em opera√ß√µes ass√≠ncronas

### ‚ùå Evitar
1. **Hardcoded credentials** ou secrets
2. **SQL direto** (usar Supabase client)
3. **Inline styles** (usar TailwindCSS)
4. **Console.log** em produ√ß√£o (usar toast)
5. **Permiss√µes inconsistentes**
6. **XSS vulnerabilities**
7. **Dados n√£o sanitizados**

### üéØ Prioridades
1. **Seguran√ßa** sempre em primeiro lugar
2. **UX consistente** com o design system
3. **Performance** e otimiza√ß√£o
4. **Manutenibilidade** do c√≥digo
5. **Documenta√ß√£o** clara

---

## üìù Conclus√£o

Este CRM da Belz √© um sistema robusto e seguro para gest√£o de propostas de planos de sa√∫de. Ao desenvolver novas funcionalidades ou fazer manuten√ß√µes, sempre priorize:

1. **Seguran√ßa** - Autentica√ß√£o, autoriza√ß√£o e sanitiza√ß√£o
2. **Usabilidade** - Interface intuitiva e responsiva  
3. **Performance** - C√≥digo otimizado e carregamento r√°pido
4. **Manutenibilidade** - C√≥digo limpo e bem documentado

**Mantenha sempre o foco na experi√™ncia do usu√°rio e na seguran√ßa dos dados!** üöÄ

---

*√öltima atualiza√ß√£o: 18 de agosto de 2025*
*Vers√£o: 1.0.0*
*Autor: GitHub Copilot Assistant*
